rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザー認証が必要な基本ルール
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 自分のデータのみアクセス可能
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // 有料会員かどうかを確認
    function isPremiumUser() {
      return exists(/databases/$(database)/documents/subscriptions/$(request.auth.uid));
    }

    // 問題データは認証済みユーザーのみ読み取り可能
    match /questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if false;  // 問題データの書き込みは管理者のみ（Admin SDKで実行）
    }
    
    // 学習進捗データは本人のみアクセス可能
    match /progress/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // 学習スケジュールも本人のみアクセス可能
    match /schedules/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }

    // プレミアム機能のデータは有料会員のみアクセス可能
    match /premium/{document=**} {
      allow read: if isAuthenticated() && isPremiumUser();
      allow write: if false;  // プレミアムコンテンツの更新は管理者のみ
    }

    // サブスクリプション状態の確認
    match /subscriptions/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if false;  // サブスクリプションの更新はサーバーサイドで管理
    }

    // ユーザープロファイル
    match /users/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
  }
}